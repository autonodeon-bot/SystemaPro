# Исправления проблем авторизации и синхронизации

## Дата: 2025-12-07

## Проблемы

### 1. Авторизация
**Проблема:** После установки приложения, если пользователь зашел под одним логином, то потом он всегда входит под этим логином, даже если вводит другого пользователя.

**Решение:**
- ✅ В `mobile/lib/screens/login_screen.dart` добавлена проверка: если введенный логин отличается от сохраненного, сначала выполняется logout старого пользователя
- ✅ В `mobile/lib/main.dart` отключен автоматический вход - теперь всегда показывается экран логина при запуске

### 2. Синхронизация
**Проблема:** 
- Синхронизация доступна всем пользователям
- Нужно, чтобы только инженеры могли синхронизировать
- В системе должно быть видно, какой инженер какие отчеты прислал (автор отчета)
- Должна быть история, кто когда прислал отчеты

**Решение:**

#### Backend:
1. ✅ Добавлена проверка роли в `/api/v1/offline/sync` - только инженеры могут синхронизировать
2. ✅ При синхронизации устанавливается `inspector_id = user.id` (автор отчета)
3. ✅ Создана модель `SyncHistory` для истории синхронизаций
4. ✅ При каждой синхронизации создается запись в `sync_history` с информацией:
   - `user_id` - инженер, который синхронизировал
   - `inspection_ids` - список синхронизированных инспекций
   - `synced_count` - количество успешно синхронизированных
   - `failed_count` - количество неудачных
   - `sync_type` - тип синхронизации (offline)
   - `created_at` - дата и время синхронизации
5. ✅ Создан эндпоинт `/api/v1/sync-history` для просмотра истории синхронизаций:
   - Инженеры видят только свою историю
   - Админы и операторы могут видеть всю историю или фильтровать по инженеру

#### Mobile:
1. ✅ В `mobile/lib/services/sync_provider.dart` добавлена проверка роли перед синхронизацией
2. ✅ В `mobile/lib/services/sync_service.dart` добавлена проверка роли перед синхронизацией
3. ✅ В `mobile/lib/screens/sync_screen.dart` добавлена проверка роли - если пользователь не инженер, показывается сообщение "Доступ запрещен"

## Измененные файлы

### Backend:
- `backend/models.py` - добавлена модель `SyncHistory`
- `backend/offline_endpoints.py` - добавлена проверка роли и сохранение истории
- `backend/get_sync_history_endpoint.py` - новый файл для эндпоинта истории
- `backend/main.py` - подключен новый роутер
- `backend/create_sync_history_table.py` - миграция для создания таблицы

### Mobile:
- `mobile/lib/screens/login_screen.dart` - исправлена авторизация
- `mobile/lib/main.dart` - отключен автоматический вход
- `mobile/lib/services/sync_provider.dart` - добавлена проверка роли
- `mobile/lib/services/sync_service.dart` - добавлена проверка роли
- `mobile/lib/screens/sync_screen.dart` - добавлена проверка роли в UI

## Миграция БД

Необходимо выполнить миграцию для создания таблицы `sync_history`:

```bash
python backend/create_sync_history_table.py
```

## Тестирование

1. **Авторизация:**
   - Войти под одним пользователем
   - Выйти
   - Войти под другим пользователем - должен войти под новым пользователем

2. **Синхронизация:**
   - Попробовать синхронизировать под ролью не engineer - должно быть запрещено
   - Синхронизировать под ролью engineer - должно работать
   - Проверить, что в `inspections.inspector_id` сохраняется ID инженера
   - Проверить, что в `sync_history` создается запись

3. **История синхронизаций:**
   - GET `/api/v1/sync-history` - должен вернуть историю
   - GET `/api/v1/sync-history?user_id=<id>` - фильтр по инженеру (только для админов)

---

**Все исправления завершены! ✅**

