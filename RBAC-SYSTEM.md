# Система разграничения доступа (RBAC)

## Версия: 3.1.0

## Роли пользователей

### 1. Администратор (admin)
**Полный доступ ко всем функциям системы**

**Права:**
- `read` - чтение всех данных
- `write` - создание и редактирование данных
- `delete` - удаление данных
- `admin` - административные функции
- `manage_users` - управление пользователями
- `manage_equipment` - управление оборудованием
- `manage_projects` - управление проектами

**Доступ:**
- Ко всем объектам (оборудование, проекты, отчеты)
- Управление пользователями и их ролями
- Настройка системы

### 2. Главный оператор (chief_operator)
**Управление операторами и инженерами, доступ ко всем данным**

**Права:**
- `read` - чтение всех данных
- `write` - создание и редактирование данных
- `delete` - удаление данных
- `manage_operators` - управление операторами
- `manage_engineers` - управление инженерами
- `manage_equipment` - управление оборудованием
- `manage_projects` - управление проектами

**Доступ:**
- Ко всем объектам (оборудование, проекты, отчеты)
- Управление операторами и инженерами
- Предоставление доступа инженерам к объектам

### 3. Оператор (operator)
**Управление инженерами на своих объектах**

**Права:**
- `read` - чтение данных
- `write` - создание и редактирование данных
- `manage_engineers` - управление инженерами (предоставление доступа)

**Доступ:**
- Ко всем объектам (оборудование, проекты)
- Предоставление доступа инженерам к объектам
- Создание и редактирование данных

### 4. Инженер (engineer)
**Доступ только к назначенным объектам**

**Права:**
- `read` - чтение данных (только к назначенным объектам)
- `write` - создание и редактирование данных (только к назначенным объектам)

**Доступ:**
- Только к объектам, на которые предоставлен доступ
- Создание отчетов по своим объектам
- Редактирование только своих объектов

## Таблицы доступа

### user_equipment_access
Связь пользователей с оборудованием:
- `user_id` - ID пользователя
- `equipment_id` - ID оборудования
- `access_type` - тип доступа: `read_only` или `read_write`
- `granted_by` - кто предоставил доступ
- `granted_at` - когда предоставлен доступ
- `expires_at` - срок действия доступа (опционально)
- `is_active` - активен ли доступ

### user_project_access
Связь пользователей с проектами:
- `user_id` - ID пользователя
- `project_id` - ID проекта
- `access_type` - тип доступа: `read_only`, `read_write` или `manage`
- `granted_by` - кто предоставил доступ
- `granted_at` - когда предоставлен доступ
- `expires_at` - срок действия доступа (опционально)
- `is_active` - активен ли доступ

## API Endpoints

### Авторизация
- `POST /api/auth/login` - вход в систему
- `GET /api/auth/me` - информация о текущем пользователе

### Управление пользователями (требует `manage_users`)
- `GET /api/users` - список пользователей
- `POST /api/users` - создание пользователя

### Управление доступом (требует роль admin, chief_operator или operator)
- `POST /api/users/{user_id}/equipment-access` - предоставить доступ к оборудованию
- `DELETE /api/users/{user_id}/equipment-access/{equipment_id}` - отозвать доступ

### Оборудование
- `GET /api/equipment` - список оборудования (фильтруется по доступу для инженеров)
- `GET /api/equipment/{id}` - информация об оборудовании (проверка доступа)
- `POST /api/equipment` - создание оборудования (требует `write`)
- `PUT /api/equipment/{id}` - обновление оборудования (проверка доступа)
- `DELETE /api/equipment/{id}` - удаление оборудования (требует `delete`)

### Инспекции
- `GET /api/inspections` - список инспекций
- `POST /api/inspections` - создание инспекции (проверка доступа к оборудованию)

## Логика проверки доступа

### Для инженеров:
1. При получении списка оборудования - фильтруется только доступное
2. При доступе к конкретному оборудованию - проверяется наличие доступа
3. При создании инспекции - проверяется доступ к оборудованию
4. При редактировании - проверяется доступ на запись

### Для операторов и выше:
- Полный доступ ко всем объектам
- Могут предоставлять доступ инженерам

## Инициализация пользователей

Запустите скрипт для создания тестовых пользователей:

```bash
python backend/init_users.py
```

Создаются пользователи:
- `admin` / `admin123` - Администратор
- `chief_operator` / `chief123` - Главный оператор
- `operator` / `operator123` - Оператор
- `engineer1` / `engineer123` - Инженер 1
- `engineer2` / `engineer123` - Инженер 2

## Безопасность

- Пароли хранятся в виде bcrypt хешей
- JWT токены с истечением срока действия (24 часа)
- Проверка прав доступа на каждом endpoint
- Фильтрация данных по доступу для инженеров

## Миграция

При обновлении системы:
1. Создаются новые таблицы: `users`, `user_equipment_access`, `user_project_access`
2. Обновляется таблица `inspections` (inspector_id теперь ссылается на users)
3. Запускается скрипт инициализации пользователей










