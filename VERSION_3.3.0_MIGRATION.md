# Миграция на версию 3.3.0 - Единая система оборудования

## Обзор изменений

Версия 3.3.0 представляет собой кардинальное изменение архитектуры системы. Основная идея - **единая база оборудования** с уникальными кодами, к которой привязываются все операции (диагностика, экспертиза, обследования).

## Ключевые изменения

### 1. Единая база оборудования

- Каждое оборудование имеет **уникальный код** (`equipment_code`)
- Оборудование больше не разделяется на "для диагностики" и "для экспертизы"
- Все операции привязываются к оборудованию по его уникальному коду

### 2. Система заданий (Assignments)

- Операторы могут создавать **задания** на диагностику/экспертизу для конкретного оборудования
- Задание назначается конкретному инженеру
- Инженер видит только назначенные ему задания в мобильном приложении
- Статусы заданий: `PENDING`, `IN_PROGRESS`, `COMPLETED`, `CANCELLED`

### 3. История обследований

- Все обследования сохраняются в единой таблице `inspection_history`
- История привязана к оборудованию по уникальному коду
- Можно просмотреть полную историю обследований конкретного оборудования

### 4. Журнал ремонта

- Новая таблица `repair_journal` для отслеживания ремонтов
- Все ремонты привязаны к оборудованию
- История ремонтов доступна для каждого оборудования

## Структура базы данных

### Новые таблицы

1. **assignments** - Задания на диагностику/экспертизу
   - `equipment_id` - ID оборудования
   - `assignment_type` - Тип задания (DIAGNOSTICS, EXPERTISE, INSPECTION)
   - `assigned_to` - ID назначенного инженера
   - `status` - Статус задания
   - `priority` - Приоритет (LOW, NORMAL, HIGH, URGENT)

2. **inspection_history** - История обследований
   - `equipment_id` - ID оборудования
   - `assignment_id` - ID задания (если обследование выполнено по заданию)
   - `inspection_type` - Тип обследования (QUESTIONNAIRE, NDT, VISUAL, EXPERTISE)
   - `inspector_id` - ID инженера
   - `inspection_date` - Дата обследования
   - `data` - Данные обследования (JSONB)

3. **repair_journal** - Журнал ремонта
   - `equipment_id` - ID оборудования
   - `repair_date` - Дата ремонта
   - `repair_type` - Тип ремонта (MAINTENANCE, REPAIR, REPLACEMENT, MODIFICATION)
   - `description` - Описание ремонта
   - `cost` - Стоимость ремонта

### Изменения в существующих таблицах

1. **equipment** - Добавлено поле `equipment_code` (уникальный код)
   - Автоматическая генерация кода при создании оборудования
   - Формат: `EQ-XXXXXXXX` (первые 8 символов UUID)

## API Endpoints

### Новые endpoints

#### Задания (Assignments)
- `POST /api/assignments` - Создать задание
- `GET /api/assignments` - Получить список заданий
- `GET /api/assignments/{id}` - Получить задание по ID
- `PUT /api/assignments/{id}` - Обновить задание
- `GET /api/assignments/{id}/equipment` - Получить информацию об оборудовании из задания

#### История оборудования
- `GET /api/equipment/{id}/history` - Получить историю обследований
- `GET /api/equipment/{id}/repairs` - Получить журнал ремонта
- `POST /api/equipment/{id}/repairs` - Создать запись в журнале ремонта
- `GET /api/equipment/{id}/summary` - Получить сводную информацию

### Изменения в существующих endpoints

- `GET /api/equipment` - Теперь возвращает `equipment_code` для каждого оборудования
- `POST /api/inspections` - Теперь создает запись в `inspection_history`

## Frontend изменения

### Новые страницы

1. **AssignmentsManagement** (`/assignments`)
   - Управление заданиями
   - Создание новых заданий
   - Фильтрация по статусу и типу
   - Просмотр назначенных заданий

### Обновления

- Все страницы, работающие с оборудованием, теперь отображают `equipment_code`
- Обновлена версия в `package.json` до `3.3.0`

## Mobile приложение изменения

### Новый функционал

1. **Работа с заданиями**
   - Синхронизация назначенных заданий
   - Отображение списка заданий
   - Выполнение заданий (опросные листы, НК)

2. **Офлайн режим**
   - Скачивание информации об оборудовании из задания
   - Сохранение в локальное хранилище
   - Работа без интернета

3. **Синхронизация**
   - При синхронизации скачиваются только назначенные задания
   - Информация об оборудовании сохраняется локально

### Обновления

- Версия обновлена до `3.3.0+1` в `pubspec.yaml`

## Процесс миграции

### Шаги выполнения

1. **Выполнить миграцию базы данных**
   ```bash
   python backend/run_migration_3.3.0.py
   ```

2. **Обновить backend**
   - Перезапустить backend сервер
   - Проверить работу новых endpoints

3. **Обновить frontend**
   - Пересобрать frontend
   - Проверить новую страницу заданий

4. **Обновить mobile приложение**
   - Пересобрать APK
   - Протестировать работу с заданиями

## Обратная совместимость

- Старые записи `inspections` остаются в базе
- Существующее оборудование автоматически получает `equipment_code` при миграции
- Старые API endpoints продолжают работать

## Важные замечания

1. **Уникальность кодов**: Каждое оборудование должно иметь уникальный код
2. **Назначения**: Инженеры видят только назначенные им задания
3. **История**: Все обследования сохраняются в истории для отслеживания
4. **Офлайн**: Мобильное приложение работает офлайн с назначенным оборудованием

## Версия

- **Backend**: 3.3.0
- **Frontend**: 3.3.0
- **Mobile**: 3.3.0+1











